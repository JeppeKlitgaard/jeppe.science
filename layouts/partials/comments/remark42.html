<script>
    var remark_config = {
      host: {{ .Site.Params.comments.remark42.url}}, // hostname of remark server, same as REMARK_URL in backend config, e.g. "https://demo.remark42.com"
      site_id: {{ .Site.Params.comments.remark42.site}},
      components: ['embed'],
      max_shown_comments: 15,
      show_email_subscription: false,
    };
</script>


<div id="remark42"></div>

<script>
    // Sync Remark42 theme to current page theme

    // https://stackoverflow.com/questions/10612024/event-trigger-on-a-class-change/53914092
    class ClassWatcher {

        constructor(targetNode, classToWatch, classAddedCallback, classRemovedCallback) {
            this.targetNode = targetNode
            this.classToWatch = classToWatch
            this.classAddedCallback = classAddedCallback
            this.classRemovedCallback = classRemovedCallback
            this.observer = null
            this.lastClassState = targetNode.classList.contains(this.classToWatch)

            this.init()
        }

        init() {
            this.observer = new MutationObserver(this.mutationCallback)
            this.observe()
        }

        observe() {
            this.observer.observe(this.targetNode, { attributes: true })
        }

        disconnect() {
            this.observer.disconnect()
        }

        mutationCallback = mutationsList => {
            for(let mutation of mutationsList) {
                if (mutation.type === 'attributes' && mutation.attributeName === 'class') {
                    let currentClassState = mutation.target.classList.contains(this.classToWatch)
                    if(this.lastClassState !== currentClassState) {
                        this.lastClassState = currentClassState
                        if(currentClassState) {
                            this.classAddedCallback()
                        }
                        else {
                            this.classRemovedCallback()
                        }
                    }
                }
            }
        }
    }

    function updateRemarkTheme() {
        let isDark = document.body.classList.contains("dark");
        let theme = isDark ? "dark" : "light";

        window.REMARK42.changeTheme(theme);
    }

    let bodyNode = document.body
    let classWatcher = new ClassWatcher(bodyNode, "dark", updateRemarkTheme, updateRemarkTheme);

    let divNode = document.querySelector("div#remark42");
    let iframeWatcher = new MutationObserver((records) => {updateRemarkTheme();});
    iframeWatcher.observe(divNode, {childList: true});

    window.addEventListener("REMARK42::ready", (event) => {updateRemarkTheme();});

    // In case we have class set at beginning
    window.addEventListener('load', (event) => {
            updateRemarkTheme();

            // Fix: sometimes we seem to miss this anyway...
            setTimeout(() => {updateRemarkTheme();}, 500); // ms
            setTimeout(() => {updateRemarkTheme();}, 3000); // ms
        });

    </script>

<script>!function(e,n){for(var o=0;o<e.length;o++){var r=n.createElement("script"),c=".js",d=n.head||n.body;"noModule"in r?(r.type="module",c=".mjs"):r.async=!0,r.defer=!0,r.src=remark_config.host+"/web/"+e[o]+c,d.appendChild(r)}}(remark_config.components||["embed"],document);</script>